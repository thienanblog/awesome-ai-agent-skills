# Python Docker Compose Template
# Generated by docker-local-dev skill
# Supports: Django, FastAPI, Flask
# Template variables: {{PROJECT_NAME}}, {{PYTHON_VERSION}}, {{DB_IMAGE}}, etc.

version: '3.8'

services:
  # Python Application (Django/FastAPI/Flask)
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: {{PROJECT_NAME}}_app
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./:/app
      - static_files:/app/staticfiles  # For Django static files
    environment:
      PYTHONUNBUFFERED: 1
      DJANGO_SETTINGS_MODULE: {{PROJECT_NAME}}.settings
      DATABASE_URL: postgres://{{DB_USER}}:{{DB_PASSWORD}}@db:5432/{{DB_DATABASE}}
      REDIS_URL: redis://redis:6379/0
      SECRET_KEY: {{SECRET_KEY}}
      DEBUG: "True"
      ALLOWED_HOSTS: "*"
    ports:
      - "${APP_PORT:-8000}:8000"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - {{PROJECT_NAME}}_network
    # For Django development:
    command: python manage.py runserver 0.0.0.0:8000
    # For FastAPI with uvicorn:
    # command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    # For production with Gunicorn:
    # command: gunicorn {{PROJECT_NAME}}.wsgi:application --bind 0.0.0.0:8000 --workers 4
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: {{PROJECT_NAME}}_nginx
    restart: unless-stopped
    ports:
      - "${NGINX_PORT:-8080}:80"
      - "${NGINX_SSL_PORT:-8443}:443"
    volumes:
      - ./docker/nginx/python-wsgi.conf:/etc/nginx/conf.d/default.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
      - static_files:/var/www/static:ro
      - ./media:/var/www/media:ro
    depends_on:
      - app
    networks:
      - {{PROJECT_NAME}}_network

  # PostgreSQL Database (Recommended for Django)
  db:
    image: postgres:16-alpine
    container_name: {{PROJECT_NAME}}_db
    restart: unless-stopped
    ports:
      - "${DB_PORT:-5432}:5432"
    environment:
      POSTGRES_DB: {{DB_DATABASE}}
      POSTGRES_USER: {{DB_USER}}
      POSTGRES_PASSWORD: {{DB_PASSWORD}}
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - {{PROJECT_NAME}}_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{DB_USER}} -d {{DB_DATABASE}}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache/Message Broker
  redis:
    image: redis:7-alpine
    container_name: {{PROJECT_NAME}}_redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - {{PROJECT_NAME}}_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Celery Worker (Optional - for background tasks)
  celery:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: {{PROJECT_NAME}}_celery
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./:/app
    environment:
      PYTHONUNBUFFERED: 1
      DJANGO_SETTINGS_MODULE: {{PROJECT_NAME}}.settings
      DATABASE_URL: postgres://{{DB_USER}}:{{DB_PASSWORD}}@db:5432/{{DB_DATABASE}}
      REDIS_URL: redis://redis:6379/0
    depends_on:
      - db
      - redis
    networks:
      - {{PROJECT_NAME}}_network
    command: celery -A {{PROJECT_NAME}} worker -l info

  # Celery Beat (Optional - for scheduled tasks)
  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: {{PROJECT_NAME}}_celery_beat
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./:/app
    environment:
      PYTHONUNBUFFERED: 1
      DJANGO_SETTINGS_MODULE: {{PROJECT_NAME}}.settings
      DATABASE_URL: postgres://{{DB_USER}}:{{DB_PASSWORD}}@db:5432/{{DB_DATABASE}}
      REDIS_URL: redis://redis:6379/0
    depends_on:
      - db
      - redis
    networks:
      - {{PROJECT_NAME}}_network
    command: celery -A {{PROJECT_NAME}} beat -l info

  # Email Testing
  mailpit:
    image: axllent/mailpit:latest
    container_name: {{PROJECT_NAME}}_mailpit
    restart: unless-stopped
    ports:
      - "${MAIL_UI_PORT:-8025}:8025"
      - "${MAIL_SMTP_PORT:-1025}:1025"
    networks:
      - {{PROJECT_NAME}}_network

networks:
  {{PROJECT_NAME}}_network:
    driver: bridge
    # For multi-project or microservices:
    # external: true
    # name: shared_network

volumes:
  db_data:
    driver: local
  redis_data:
    driver: local
  static_files:
    driver: local
