# Node.js Docker Compose Template
# Generated by docker-local-dev skill
# Supports: Express, NestJS, Fastify, Next.js
# Template variables: {{PROJECT_NAME}}, {{NODE_VERSION}}, {{DB_IMAGE}}, etc.

version: '3.8'

services:
  # Node.js Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: {{PROJECT_NAME}}_app
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./:/app
      - /app/node_modules  # Named volume for node_modules (performance)
    environment:
      NODE_ENV: development
      PORT: 3000
      DB_HOST: db
      DB_PORT: {{DB_PORT_INTERNAL}}
      DB_NAME: {{DB_DATABASE}}
      DB_USER: {{DB_USER}}
      DB_PASSWORD: {{DB_PASSWORD}}
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "${APP_PORT:-3000}:3000"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - {{PROJECT_NAME}}_network
    # For development with hot reload:
    command: npm run dev
    # For PM2 in production-like mode:
    # command: pm2-runtime start ecosystem.config.js
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Nginx Reverse Proxy (Optional - for production-like setup)
  nginx:
    image: nginx:alpine
    container_name: {{PROJECT_NAME}}_nginx
    restart: unless-stopped
    ports:
      - "${NGINX_PORT:-8080}:80"
      - "${NGINX_SSL_PORT:-8443}:443"
    volumes:
      - ./docker/nginx/node-proxy.conf:/etc/nginx/conf.d/default.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
      - ./public:/var/www/public:ro  # Static files
    depends_on:
      - app
    networks:
      - {{PROJECT_NAME}}_network

  # Database Server (MySQL/MariaDB)
  db:
    image: {{DB_IMAGE}}
    container_name: {{PROJECT_NAME}}_db
    restart: unless-stopped
    ports:
      - "${DB_PORT:-3306}:3306"
    environment:
      MYSQL_ROOT_PASSWORD: {{DB_ROOT_PASSWORD}}
      MYSQL_DATABASE: {{DB_DATABASE}}
      MYSQL_USER: {{DB_USER}}
      MYSQL_PASSWORD: {{DB_PASSWORD}}
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - {{PROJECT_NAME}}_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p{{DB_ROOT_PASSWORD}}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Alternative (uncomment if using PostgreSQL)
  # db:
  #   image: postgres:16-alpine
  #   container_name: {{PROJECT_NAME}}_db
  #   restart: unless-stopped
  #   ports:
  #     - "${DB_PORT:-5432}:5432"
  #   environment:
  #     POSTGRES_DB: {{DB_DATABASE}}
  #     POSTGRES_USER: {{DB_USER}}
  #     POSTGRES_PASSWORD: {{DB_PASSWORD}}
  #   volumes:
  #     - db_data:/var/lib/postgresql/data
  #   networks:
  #     - {{PROJECT_NAME}}_network
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U {{DB_USER}} -d {{DB_DATABASE}}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: {{PROJECT_NAME}}_redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - {{PROJECT_NAME}}_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Email Testing
  mailpit:
    image: axllent/mailpit:latest
    container_name: {{PROJECT_NAME}}_mailpit
    restart: unless-stopped
    ports:
      - "${MAIL_UI_PORT:-8025}:8025"
      - "${MAIL_SMTP_PORT:-1025}:1025"
    networks:
      - {{PROJECT_NAME}}_network

  # Cron/Scheduler via Supervisor (Optional)
  # scheduler:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   container_name: {{PROJECT_NAME}}_scheduler
  #   restart: unless-stopped
  #   working_dir: /app
  #   volumes:
  #     - ./:/app
  #     - /app/node_modules
  #     - ./docker/supervisor/node-cron.conf:/etc/supervisor/conf.d/cron.conf:ro
  #   environment:
  #     NODE_ENV: development
  #   depends_on:
  #     - db
  #     - redis
  #   networks:
  #     - {{PROJECT_NAME}}_network
  #   command: ["supervisord", "-c", "/etc/supervisor/supervisord.conf"]

networks:
  {{PROJECT_NAME}}_network:
    driver: bridge
    # For multi-project or microservices:
    # external: true
    # name: shared_network

volumes:
  db_data:
    driver: local
  redis_data:
    driver: local
